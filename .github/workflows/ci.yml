name: CI - IoT Environment Monitor

on:
  push:
    branches: [ main, develop, feature/mqtt ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-c-firmware:
    name: Build C Firmware
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make cmake

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build firmware
      run: |
        cd build
        cmake --build . --config ${{ env.BUILD_TYPE }}

    - name: Verify Linux library naming
      run: |
        echo "✅ 构建完成，检查输出文件:"
        ls -la build/bin/ || echo "build/bin 目录不存在"

  test-python-services:
    name: Test Python Services
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: |
        pip install pytest paho-mqtt numpy scikit-learn joblib

    - name: Run basic Python tests
      run: |
        python -c "import paho.mqtt.client as mqtt; print('MQTT import OK')"
        python -c "import sqlite3; print('SQLite import OK')"
        python -c "import sklearn; print('scikit-learn import OK')"
        python -c "import joblib; print('joblib import OK')"
        python -c "import numpy; print('numpy import OK')"


  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-c-firmware, test-python-services]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install test dependencies
      run: |
        pip install pytest paho-mqtt


    - name: Run test_engine tests
      run: |
        export PYTHONPATH=$PWD:$PWD/IoT_EnvMonitorSys_Basic/cloud_services
        cd test_engine
        
        # 手动指定要运行的测试文件
        pytest tests/test_cloud_services.py -v
        pytest tests/test_complete_data_flow.py -v
        pytest tests/test_sensor.py -v
        pytest tests/test_integration.py -v